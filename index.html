<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>TASKS</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --bg:#0e0e0f; --surface:#161618; --surface2:#1e1e21;
  --border:#2a2a2e; --accent:#e8ff47; --accent2:#ff6b35;
  --text:#f0f0f0; --muted:#666;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bot: env(safe-area-inset-bottom, 0px);
  --sidebar-w: 272px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{height:100%;}
body{
  background:var(--bg);color:var(--text);
  font-family:'DM Sans',sans-serif;min-height:100vh;
  display:grid;grid-template-columns:var(--sidebar-w) 1fr;grid-template-rows:auto 1fr;
  overflow-x:hidden;
}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;opacity:0.3;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");}

/* ‚îÄ‚îÄ‚îÄ LOGIN MODAL ‚îÄ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.92);display:flex;align-items:center;justify-content:center;z-index:2000;backdrop-filter:blur(10px);padding:20px;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:36px 32px;width:100%;max-width:380px;text-align:center;animation:popIn 0.3s cubic-bezier(0.175,0.885,0.32,1.275);}
@keyframes popIn{from{opacity:0;transform:scale(0.85)}to{opacity:1;transform:scale(1)}}
.modal-logo{font-family:'Bebas Neue',sans-serif;font-size:44px;letter-spacing:4px;color:var(--accent);margin-bottom:2px;}
.modal-sub{font-size:11px;color:var(--muted);margin-bottom:24px;letter-spacing:2px;text-transform:uppercase;}
.modal p{font-size:13px;color:var(--muted);margin-bottom:20px;line-height:1.6;}
.user-options{display:flex;flex-direction:column;gap:10px;}
.user-btn{display:flex;align-items:center;gap:14px;background:var(--surface2);border:2px solid var(--border);border-radius:14px;padding:16px 18px;cursor:pointer;transition:all 0.2s;color:var(--text);font-family:'DM Sans',sans-serif;font-size:16px;font-weight:500;text-align:left;min-height:62px;}
.user-btn.grant-btn{border-color:rgba(232,255,71,0.3);}
.user-btn.grant-btn:hover{border-color:var(--accent);background:rgba(232,255,71,0.05);transform:translateX(4px);}
.user-btn.will-btn{border-color:rgba(255,107,53,0.3);}
.user-btn.will-btn:hover{border-color:var(--accent2);background:rgba(255,107,53,0.05);transform:translateX(4px);}
.u-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.u-info{flex:1;}
.u-name{font-size:16px;font-weight:600;}
.u-role{font-size:11px;color:var(--muted);margin-top:2px;}

/* ‚îÄ‚îÄ‚îÄ TASK DETAIL MODAL ‚îÄ‚îÄ‚îÄ */
.task-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.88);display:none;align-items:flex-end;justify-content:center;z-index:1500;backdrop-filter:blur(8px);}
.task-modal-overlay.open{display:flex;}
@media(min-width:600px){.task-modal-overlay{align-items:center;padding:20px;}}
.task-modal{background:var(--surface);border:1px solid var(--border);border-radius:20px 20px 0 0;width:100%;max-width:560px;max-height:92vh;display:flex;flex-direction:column;animation:slideUp 0.3s cubic-bezier(0.175,0.885,0.32,1.275);overflow:hidden;}
@media(min-width:600px){.task-modal{border-radius:20px;animation:popIn 0.25s cubic-bezier(0.175,0.885,0.32,1.275);}}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.tm-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:14px auto 0;}
@media(min-width:600px){.tm-handle{display:none;}}
.tm-header{padding:16px 20px 14px;border-bottom:1px solid var(--border);flex-shrink:0;position:relative;}
.tm-title{font-size:16px;font-weight:600;line-height:1.4;margin-bottom:10px;padding-right:36px;}
.tm-close{position:absolute;top:14px;right:14px;background:none;border:none;color:var(--muted);font-size:22px;cursor:pointer;padding:4px 8px;border-radius:6px;line-height:1;}
.tm-close:hover{color:var(--text);}
.tm-meta{display:flex;flex-wrap:wrap;gap:6px;align-items:center;}
.tm-body{flex:1;overflow-y:auto;padding:14px 20px 8px;}
.tm-footer{padding:12px 20px calc(12px + var(--safe-bot));border-top:1px solid var(--border);flex-shrink:0;}

/* Handoff buttons */
.handoff-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;}
.hbtn{padding:11px 10px;border-radius:10px;border:none;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;justify-content:center;gap:6px;min-height:44px;}
.hbtn:active{transform:scale(0.96);}
.hbtn.current{outline:2px solid var(--accent);outline-offset:2px;}
.hbtn-start{background:rgba(96,165,250,0.15);color:#60a5fa;border:1px solid rgba(96,165,250,0.3);}
.hbtn-start:hover{background:rgba(96,165,250,0.25);}
.hbtn-needs-grant{background:rgba(255,107,53,0.15);color:var(--accent2);border:1px solid rgba(255,107,53,0.3);}
.hbtn-needs-grant:hover{background:rgba(255,107,53,0.25);}
.hbtn-needs-will{background:rgba(168,85,247,0.15);color:#a855f7;border:1px solid rgba(168,85,247,0.3);}
.hbtn-needs-will:hover{background:rgba(168,85,247,0.25);}
.hbtn-done{background:rgba(232,255,71,0.15);color:var(--accent);border:1px solid rgba(232,255,71,0.3);}
.hbtn-done:hover{background:rgba(232,255,71,0.25);}
.hbtn-reopen{background:rgba(255,255,255,0.05);color:var(--muted);border:1px solid var(--border);}
.hbtn-reopen:hover{border-color:var(--accent);color:var(--accent);}
.hbtn-delete{background:rgba(239,68,68,0.1);color:#ef4444;border:1px solid rgba(239,68,68,0.2);}
.hbtn-delete:hover{background:rgba(239,68,68,0.2);}

/* Comments */
.comments-label{font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:8px;}
.comment-thread{display:flex;flex-direction:column;gap:7px;margin-bottom:12px;max-height:200px;overflow-y:auto;}
.comment{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;}
.comment.by-grant{border-left:3px solid var(--accent);}
.comment.by-will{border-left:3px solid var(--accent2);}
.comment-header{display:flex;align-items:center;gap:6px;margin-bottom:4px;}
.comment-author{font-size:12px;font-weight:600;}
.comment-time{font-size:10px;color:var(--muted);margin-left:auto;}
.comment-text{font-size:13px;line-height:1.5;}
.no-comments{font-size:12px;color:var(--muted);padding:12px 0;text-align:center;}
.comment-input-row{display:flex;gap:8px;align-items:flex-end;}
.comment-input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:11px 13px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;resize:none;min-height:44px;max-height:80px;}
.comment-input:focus{border-color:var(--accent);}
.comment-input::placeholder{color:var(--muted);}
.comment-send{background:var(--accent);color:#000;border:none;border-radius:10px;padding:11px 16px;font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:1px;cursor:pointer;min-height:44px;white-space:nowrap;}
.comment-send:active{transform:scale(0.96);}

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:14px 24px;padding-top:calc(14px + var(--safe-top));border-bottom:1px solid var(--border);background:var(--bg);position:sticky;top:0;z-index:100;}
.logo{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:4px;color:var(--accent);}
.logo small{color:var(--text);font-size:10px;font-family:'DM Sans',sans-serif;font-weight:300;letter-spacing:1.5px;display:block;margin-top:-4px;}
.h-right{display:flex;align-items:center;gap:12px;}
.sync-row{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted);}
.sdot{width:7px;height:7px;border-radius:50%;background:var(--muted);}
.sdot.ok{background:var(--accent);}
.sdot.busy{background:var(--accent2);animation:pulse 0.8s infinite;}
.sdot.err{background:#ef4444;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(0.8)}}
.user-pill{display:flex;align-items:center;gap:7px;background:var(--surface);border:1px solid var(--border);border-radius:100px;padding:6px 14px 6px 6px;font-size:13px;cursor:pointer;transition:border-color 0.15s;min-height:38px;}
.user-pill:hover{border-color:var(--accent);}
.pill-av{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--accent);margin-left:3px;animation:pulse 2s infinite;}
.date-disp{text-align:right;font-size:11px;color:var(--muted);}
.date-disp strong{display:block;color:var(--text);font-size:13px;font-weight:500;}
.role-badge{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;padding:4px 10px;border-radius:100px;font-weight:600;}
.role-badge.grant{background:rgba(232,255,71,0.15);color:var(--accent);border:1px solid rgba(232,255,71,0.3);}
.role-badge.will{background:rgba(255,107,53,0.15);color:var(--accent2);border:1px solid rgba(255,107,53,0.3);}

/* Mobile stats */
.mobile-stats-bar{display:none;grid-column:1/-1;padding:10px 16px;gap:8px;background:var(--surface);border-bottom:1px solid var(--border);overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.mobile-stats-bar::-webkit-scrollbar{display:none;}
.msb-item{flex-shrink:0;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 14px;min-width:72px;text-align:center;}
.msb-n{font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--accent);line-height:1;}
.msb-n.o{color:var(--accent2);}
.msb-l{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
aside{background:var(--surface);border-right:1px solid var(--border);padding:20px 14px;display:flex;flex-direction:column;gap:22px;overflow-y:auto;}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;}
.sc{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:12px 10px;transition:border-color 0.2s;}
.sc:hover{border-color:var(--accent);}
.sc .n{font-family:'Bebas Neue',sans-serif;font-size:30px;color:var(--accent);line-height:1;}
.sc.o .n{color:var(--accent2);}
.sc .l{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:2px;}
.prog{display:flex;flex-direction:column;align-items:center;gap:8px;}
.ring-wrap{position:relative;width:100px;height:100px;}
.ring-wrap svg{transform:rotate(-90deg);}
.rb{fill:none;stroke:var(--border);stroke-width:8;}
.rf{fill:none;stroke:var(--accent);stroke-width:8;stroke-linecap:round;stroke-dasharray:283;stroke-dashoffset:283;transition:stroke-dashoffset 1s cubic-bezier(0.4,0,0.2,1);}
.rl{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.rp{font-family:'Bebas Neue',sans-serif;font-size:27px;color:var(--accent);line-height:1;}
.rs{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
.slabel{font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:6px;}
.ci{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;cursor:pointer;transition:background 0.15s;margin-bottom:2px;}
.ci:hover{background:var(--surface2);}
.cdot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.cn{font-size:13px;flex:1;}
.cc{font-size:11px;color:var(--muted);}
.ou{display:flex;flex-direction:column;gap:5px;}
.ou-row{display:flex;align-items:center;gap:7px;font-size:13px;}
.ou-dot{width:7px;height:7px;border-radius:50%;background:var(--accent);}
.upcoming-list{display:flex;flex-direction:column;gap:5px;}
.up-item{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 10px;cursor:pointer;transition:border-color 0.15s;}
.up-item:hover{border-color:var(--accent);}
.up-text{font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.up-date{font-size:10px;color:var(--muted);margin-top:2px;}

/* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
main{padding:20px 22px;overflow-y:auto;padding-bottom:calc(20px + var(--safe-bot));}
.mh{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.st{font-family:'Bebas Neue',sans-serif;font-size:38px;letter-spacing:2px;line-height:1;}
.st span{color:var(--accent);}

/* Alert sections */
.alert-section{border-radius:14px;padding:14px 16px;margin-bottom:16px;}
.alert-section.grant-alert{background:rgba(255,107,53,0.06);border:1px solid rgba(255,107,53,0.25);}
.alert-section.will-alert{background:rgba(168,85,247,0.05);border:1px solid rgba(168,85,247,0.2);}
.alert-header{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.alert-badge{font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:1px;padding:3px 10px;border-radius:6px;}
.alert-badge.orange{background:var(--accent2);color:#000;}
.alert-badge.purple{background:#a855f7;color:#fff;}
.alert-item{background:var(--surface);border:1px solid rgba(255,107,53,0.2);border-radius:10px;padding:11px 13px;margin-bottom:7px;cursor:pointer;transition:all 0.15s;}
.alert-item.purple-item{border-color:rgba(168,85,247,0.2);}
.alert-item:last-child{margin-bottom:0;}
.alert-item:hover{transform:translateX(2px);}
.alert-item-title{font-size:13px;font-weight:500;margin-bottom:5px;}
.alert-last-msg{font-size:12px;color:var(--muted);padding:6px 9px;background:var(--surface2);border-radius:6px;border-left:3px solid var(--accent2);line-height:1.4;}
.alert-last-msg.purple{border-left-color:#a855f7;}
.alert-last-msg strong{color:var(--accent2);}
.alert-last-msg.purple strong{color:#a855f7;}

/* Role banner */
.role-banner{border-radius:12px;padding:10px 14px;margin-bottom:14px;font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px;}
.role-banner.grant{background:rgba(232,255,71,0.05);border:1px solid rgba(232,255,71,0.15);}
.role-banner.grant strong{color:var(--accent);}
.role-banner.will{background:rgba(255,107,53,0.05);border:1px solid rgba(255,107,53,0.15);}
.role-banner.will strong{color:var(--accent2);}

/* Import */
.import-zone{border:2px dashed var(--border);border-radius:12px;padding:13px 16px;display:flex;align-items:center;gap:12px;margin-bottom:16px;cursor:pointer;transition:all 0.2s;background:var(--surface);}
.import-zone:hover,.import-zone.drag-over{border-color:var(--accent);}
.iz-icon{font-size:20px;}.iz-t{font-size:13px;font-weight:500;}.iz-s{font-size:11px;color:var(--muted);margin-top:2px;}
#file-input{display:none;}
.iz-badge{margin-left:auto;background:var(--accent);color:#000;font-family:'Bebas Neue',sans-serif;font-size:12px;letter-spacing:1px;padding:4px 10px;border-radius:6px;}

/* Add bar */
.add-bar{display:flex;gap:7px;margin-bottom:16px;align-items:stretch;}
.add-bar .ai{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 15px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;outline:none;transition:border-color 0.2s;-webkit-appearance:none;min-height:46px;}
.add-bar .ai:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(232,255,71,0.07);}
.add-bar .ai::placeholder{color:var(--muted);}
.add-bar .sel{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;cursor:pointer;-webkit-appearance:none;min-height:46px;}
.add-bar .abtn{background:var(--accent);color:#000;border:none;border-radius:10px;padding:12px 18px;font-family:'Bebas Neue',sans-serif;font-size:17px;letter-spacing:2px;cursor:pointer;transition:all 0.15s;white-space:nowrap;min-height:46px;}
.add-bar .abtn:active{transform:scale(0.97);}

/* Tabs */
.tabs{display:flex;gap:5px;margin-bottom:14px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:2px;}
.tabs::-webkit-scrollbar{display:none;}
.tab{flex-shrink:0;padding:7px 14px;border-radius:100px;font-size:11px;text-transform:uppercase;letter-spacing:1px;cursor:pointer;border:1px solid var(--border);color:var(--muted);background:transparent;transition:all 0.15s;white-space:nowrap;min-height:34px;}
.tab:hover{border-color:var(--accent);color:var(--accent);}
.tab.active{background:var(--accent);color:#000;border-color:var(--accent);font-weight:500;}

/* Task cards */
.tlist{display:flex;flex-direction:column;gap:7px;}
.ti{display:flex;align-items:flex-start;gap:11px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:13px 14px;cursor:pointer;transition:border-color 0.15s,background 0.15s;position:relative;overflow:hidden;}
.ti::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--dc,var(--border));border-radius:3px 0 0 3px;}
.ti:hover{border-color:rgba(232,255,71,0.3);background:rgba(255,255,255,0.01);}
.ti.is-done{opacity:0.4;}
.ti.is-done .tt{text-decoration:line-through;color:var(--muted);}
.ti.status-needs-grant{border-color:rgba(255,107,53,0.4)!important;background:rgba(255,107,53,0.025);}
.ti.status-in-progress{border-color:rgba(96,165,250,0.25)!important;}
.ti.status-needs-will{border-color:rgba(168,85,247,0.3)!important;}
.status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:5px;}
.sd-pending{background:var(--muted);}
.sd-in-progress{background:#60a5fa;}
.sd-needs-grant{background:var(--accent2);}
.sd-needs-will{background:#a855f7;}
.sd-done{background:var(--accent);}
.ti-body{flex:1;min-width:0;}
.tt{font-size:14px;line-height:1.4;margin-bottom:6px;}
.tm{display:flex;align-items:center;gap:5px;flex-wrap:wrap;}
.tcat{font-size:10px;padding:3px 8px;border-radius:100px;background:var(--surface2);color:var(--muted);}
.tpri{font-size:10px;text-transform:uppercase;letter-spacing:1px;padding:3px 7px;border-radius:4px;font-weight:500;}
.ph{background:rgba(255,107,53,0.15);color:var(--accent2);}
.pm{background:rgba(232,255,71,0.1);color:var(--accent);}
.pl{background:rgba(255,255,255,0.05);color:var(--muted);}
.tauth{font-size:10px;color:var(--muted);}
.status-chip{font-size:10px;padding:3px 8px;border-radius:100px;font-weight:600;white-space:nowrap;}
.sc-pending{background:rgba(255,255,255,0.05);color:var(--muted);border:1px solid var(--border);}
.sc-in-progress{background:rgba(96,165,250,0.12);color:#60a5fa;border:1px solid rgba(96,165,250,0.3);}
.sc-needs-grant{background:rgba(255,107,53,0.15);color:var(--accent2);border:1px solid rgba(255,107,53,0.3);}
.sc-needs-will{background:rgba(168,85,247,0.12);color:#a855f7;border:1px solid rgba(168,85,247,0.3);}
.sc-done{background:rgba(232,255,71,0.1);color:var(--accent);border:1px solid rgba(232,255,71,0.2);}
.ti-right{display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0;}
.comment-pill{font-size:11px;background:var(--surface2);border:1px solid var(--border);border-radius:100px;padding:3px 9px;color:var(--muted);white-space:nowrap;}
.comment-pill.has-c{background:rgba(232,255,71,0.08);border-color:rgba(232,255,71,0.25);color:var(--accent);}
.dbtn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:4px 6px;border-radius:6px;transition:all 0.15s;min-width:28px;min-height:28px;display:flex;align-items:center;justify-content:center;}
.dbtn:hover{color:#ef4444;background:rgba(239,68,68,0.1);}

/* Due chips */
.due-chip{display:inline-flex;align-items:center;gap:3px;font-size:10px;padding:3px 8px;border-radius:100px;font-weight:500;white-space:nowrap;}
.due-chip.overdue{background:rgba(255,107,53,0.18);color:var(--accent2);border:1px solid rgba(255,107,53,0.3);}
.due-chip.today{background:rgba(232,255,71,0.15);color:var(--accent);border:1px solid rgba(232,255,71,0.3);}
.due-chip.soon{background:rgba(96,165,250,0.12);color:#60a5fa;border:1px solid rgba(96,165,250,0.25);}
.due-chip.future{background:rgba(255,255,255,0.05);color:var(--muted);border:1px solid var(--border);}

.empty{text-align:center;padding:40px 20px;color:var(--muted);font-size:14px;}
.empty-i{font-size:32px;display:block;margin-bottom:8px;opacity:0.35;}
.toast{position:fixed;bottom:calc(24px + var(--safe-bot));right:20px;background:var(--surface);border:1px solid var(--accent);border-radius:10px;padding:11px 16px;font-size:13px;box-shadow:0 8px 30px rgba(0,0,0,0.4);animation:toastIn 0.3s ease;z-index:9000;display:flex;align-items:center;gap:8px;max-width:calc(100vw - 40px);}
@keyframes toastIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.fab{display:none;position:fixed;bottom:calc(24px + var(--safe-bot));right:20px;width:56px;height:56px;border-radius:50%;background:var(--accent);color:#000;border:none;font-size:28px;cursor:pointer;z-index:300;box-shadow:0 4px 20px rgba(232,255,71,0.4);align-items:center;justify-content:center;transition:transform 0.15s;}
.fab:active{transform:scale(0.92);}
.add-sheet{display:none;position:fixed;inset:0;z-index:400;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);align-items:flex-end;}
.add-sheet.open{display:flex;}
.add-sheet-inner{background:var(--surface);border-top:1px solid var(--border);border-radius:20px 20px 0 0;padding:20px 20px calc(20px + var(--safe-bot));width:100%;animation:slideUp 0.3s cubic-bezier(0.175,0.885,0.32,1.275);}
.sheet-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 18px;}
.sheet-title{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;color:var(--accent);margin-bottom:14px;}
.sheet-field{margin-bottom:11px;}
.sheet-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px;}
.sheet-input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 15px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:16px;outline:none;-webkit-appearance:none;}
.sheet-input:focus{border-color:var(--accent);}
.sheet-input::placeholder{color:var(--muted);}
.sheet-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:11px;}
.sheet-select{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;outline:none;-webkit-appearance:none;cursor:pointer;}
.sheet-add-btn{width:100%;background:var(--accent);color:#000;border:none;border-radius:12px;padding:16px;font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;cursor:pointer;margin-top:4px;min-height:54px;}
.sheet-close{position:absolute;top:16px;right:20px;background:none;border:none;color:var(--muted);font-size:22px;cursor:pointer;padding:4px;}
.loading-overlay{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:3000;gap:16px;}
.loading-logo{font-family:'Bebas Neue',sans-serif;font-size:48px;letter-spacing:6px;color:var(--accent);}
.loading-sub{font-size:12px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;}
.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

@media(max-width:900px){:root{--sidebar-w:220px;}aside{padding:16px 12px;gap:18px;}.sc .n{font-size:26px;}.sync-row{display:none;}}
@media(max-width:680px){
  body{grid-template-columns:1fr;grid-template-rows:auto auto 1fr;}
  aside{display:none;}.mobile-stats-bar{display:flex;}
  main{padding:14px 14px calc(100px + var(--safe-bot));}.st{font-size:30px;}
  .import-zone{padding:12px 14px;gap:10px;}.iz-s{display:none;}
  .add-bar{display:none;}.fab{display:flex;}
  .toast{bottom:calc(90px + var(--safe-bot));right:14px;}
  .ti{padding:12px;}.handoff-grid{grid-template-columns:1fr;}
}
@media(max-width:380px){.modal{padding:28px 20px;}.sheet-row{grid-template-columns:1fr;}}
</style>
</head>
<body>

<div class="loading-overlay" id="loading">
  <div class="loading-logo">TASKS</div>
  <div class="spinner"></div>
  <div class="loading-sub">Connecting‚Ä¶</div>
</div>

<div class="modal-overlay" id="modal" style="display:none;">
  <div class="modal">
    <div class="modal-logo">TASKS</div>
    <div class="modal-sub">Grant &amp; Will's Dashboard</div>
    <p>Who are you? Your view and permissions are set automatically.</p>
    <div class="user-options">
      <button class="user-btn grant-btn" onclick="login('Grant','ü¶Ö','grant')">
        <div class="u-avatar" style="background:rgba(232,255,71,0.15)">ü¶Ö</div>
        <div class="u-info"><div class="u-name">Grant</div><div class="u-role">Assign tasks ¬∑ See action queue</div></div>
        <span style="font-size:20px;margin-left:auto">‚Üí</span>
      </button>
      <button class="user-btn will-btn" onclick="login('Will','ü¶Å','will')">
        <div class="u-avatar" style="background:rgba(255,107,53,0.15)">ü¶Å</div>
        <div class="u-info"><div class="u-name">Will</div><div class="u-role">Execute tasks ¬∑ Request input</div></div>
        <span style="font-size:20px;margin-left:auto">‚Üí</span>
      </button>
    </div>
  </div>
</div>

<!-- TASK DETAIL MODAL -->
<div class="task-modal-overlay" id="task-modal" onclick="taskModalBgClick(event)">
  <div class="task-modal">
    <div class="tm-handle"></div>
    <div class="tm-header">
      <button class="tm-close" onclick="closeTaskModal()">‚úï</button>
      <div class="tm-title" id="tmd-title">‚Äî</div>
      <div class="tm-meta" id="tmd-meta"></div>
    </div>
    <div class="tm-body">
      <div class="comments-label">Thread</div>
      <div class="comment-thread" id="tmd-comments"></div>
    </div>
    <div class="tm-footer">
      <div class="comment-input-row" style="margin-bottom:10px;">
        <textarea class="comment-input" id="comment-input" placeholder="Add a comment (optional)‚Ä¶" rows="1"></textarea>
        <button class="comment-send" onclick="submitComment()">SEND</button>
      </div>
      <div class="handoff-grid" id="tmd-handoff"></div>
    </div>
  </div>
</div>

<header>
  <div class="logo">TASKS <small>SHARED DASHBOARD</small></div>
  <div class="h-right">
    <div class="sync-row"><div class="sdot ok" id="sdot"></div><span id="slbl">Live</span></div>
    <div id="role-badge-wrap"></div>
    <div class="user-pill" onclick="showModal()">
      <div class="pill-av" id="hav">üë§</div>
      <span id="hun">‚Äî</span>
      <div class="live-dot"></div>
    </div>
    <div class="date-disp"><strong id="ds">‚Äî</strong><span id="ts">‚Äî</span></div>
  </div>
</header>

<div class="mobile-stats-bar">
  <div class="msb-item"><div class="msb-n" id="mtc">0</div><div class="msb-l">Total</div></div>
  <div class="msb-item"><div class="msb-n o" id="mpc">0</div><div class="msb-l">Pending</div></div>
  <div class="msb-item"><div class="msb-n" id="mdc">0</div><div class="msb-l">Done</div></div>
  <div class="msb-item"><div class="msb-n o" id="mhc">0</div><div class="msb-l">High</div></div>
  <div class="msb-item"><div class="msb-n" id="mac" style="color:var(--accent2)">0</div><div class="msb-l">‚ö° Action</div></div>
</div>

<aside>
  <div class="stats-grid">
    <div class="sc"><div class="n" id="tc">0</div><div class="l">Total</div></div>
    <div class="sc o"><div class="n" id="pc">0</div><div class="l">Pending</div></div>
    <div class="sc"><div class="n" id="dc">0</div><div class="l">Done</div></div>
    <div class="sc o"><div class="n" id="hc">0</div><div class="l">High Pri</div></div>
  </div>
  <div class="prog">
    <div class="ring-wrap">
      <svg width="100" height="100" viewBox="0 0 100 100">
        <circle class="rb" cx="50" cy="50" r="45"/>
        <circle class="rf" id="ring" cx="50" cy="50" r="45"/>
      </svg>
      <div class="rl"><div class="rp" id="pct">0%</div><div class="rs">Done</div></div>
    </div>
    <div style="font-size:11px;color:var(--muted)">Completion Rate</div>
  </div>
  <div><div class="slabel">Categories</div><div id="catlist"></div></div>
  <div><div class="slabel">‚è∞ Upcoming</div><div class="upcoming-list" id="upcoming"></div></div>
  <div><div class="slabel">Online Now</div><div class="ou" id="oulist"></div></div>
</aside>

<main>
  <div class="mh"><div class="st" id="page-title">TASKS</div></div>
  <div id="role-banner-wrap"></div>
  <div id="grant-action-wrap" style="display:none;"></div>
  <div id="will-waiting-wrap" style="display:none;"></div>

  <div class="import-zone" id="iz" onclick="document.getElementById('file-input').click()" style="display:none;">
    <div class="iz-icon">üìä</div>
    <div><div class="iz-t">Import Excel or CSV</div><div class="iz-s">Drop or tap ‚Äî auto-maps columns</div></div>
    <div class="iz-badge">IMPORT</div>
    <input type="file" id="file-input" accept=".xlsx,.xls,.csv" />
  </div>

  <div class="add-bar" id="add-bar" style="display:none;">
    <input class="ai" id="task-input" placeholder="Add a task for Will‚Ä¶" autocomplete="off" />
    <select class="sel" id="cat-sel"><option>Work</option><option>Personal</option><option>Health</option><option>Finance</option><option>Other</option></select>
    <select class="sel" id="pri-sel"><option value="high">üî¥ High</option><option value="med" selected>üü° Med</option><option value="low">‚ö™ Low</option></select>
    <input class="ai" type="date" id="due-input" style="flex:0 0 auto;width:144px;" />
    <input class="ai" id="note-input" placeholder="Note‚Ä¶" style="flex:0.5;" autocomplete="off" />
    <button class="abtn" onclick="addTask()">ADD</button>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="setFilter('all',this)">All</button>
    <button class="tab" onclick="setFilter('active',this)">Active</button>
    <button class="tab" onclick="setFilter('in-progress',this)">In Progress</button>
    <button class="tab" onclick="setFilter('needs-grant',this)">‚ö° Needs Grant</button>
    <button class="tab" onclick="setFilter('done',this)">Done</button>
    <button class="tab" onclick="setFilter('high',this)">üî¥ High</button>
  </div>

  <div class="tlist" id="tlist"></div>
</main>

<button class="fab" id="fab" onclick="openSheet()" style="display:none;">+</button>

<div class="add-sheet" id="add-sheet" onclick="sheetBgClick(event)">
  <div class="add-sheet-inner" style="position:relative;">
    <div class="sheet-handle"></div>
    <button class="sheet-close" onclick="closeSheet()">‚úï</button>
    <div class="sheet-title">NEW TASK</div>
    <div class="sheet-field"><div class="sheet-label">Task</div><input class="sheet-input" id="sheet-task" placeholder="What needs to be done?" autocomplete="off" /></div>
    <div class="sheet-field"><div class="sheet-label">Note (optional)</div><input class="sheet-input" id="sheet-note" placeholder="Context‚Ä¶" autocomplete="off" /></div>
    <div class="sheet-row">
      <div><div class="sheet-label">Category</div><select class="sheet-select" id="sheet-cat"><option>Work</option><option>Personal</option><option>Health</option><option>Finance</option><option>Other</option></select></div>
      <div><div class="sheet-label">Priority</div><select class="sheet-select" id="sheet-pri"><option value="high">üî¥ High</option><option value="med" selected>üü° Med</option><option value="low">‚ö™ Low</option></select></div>
    </div>
    <div class="sheet-field"><div class="sheet-label">Due Date (optional)</div><input class="sheet-input" type="date" id="sheet-due" /></div>
    <button class="sheet-add-btn" onclick="addTaskMobile()">ADD TASK</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD17L86ysLCw6yzFcqzEaYQ3wa7JNNHzJY",
  authDomain: "grants-todo-list.firebaseapp.com",
  projectId: "grants-todo-list",
  storageBucket: "grants-todo-list.firebasestorage.app",
  messagingSenderId: "131026362747",
  appId: "1:131026362747:web:f639daadfe5fc0acbc9dde"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const CAT_C = {Work:'#e8ff47',Personal:'#ff6b35',Health:'#4ecdc4',Finance:'#a855f7',Other:'#64748b'};
const STATUS_LABEL = {'pending':'‚¨ú Pending','in-progress':'üîµ In Progress','needs-grant':'üü† Needs Grant','needs-will':'üü£ Needs Will','done':'‚úÖ Done'};

let me = null, tasks = [], filter = 'all', activeTaskId = null;

/* ‚îÄ‚îÄ Login ‚îÄ‚îÄ */
window.login = function(name, avatar, role) {
  me = {name, avatar, role};
  document.getElementById('modal').style.display = 'none';
  document.getElementById('hav').textContent = avatar;
  document.getElementById('hun').textContent = name;
  document.getElementById('role-badge-wrap').innerHTML = `<span class="role-badge ${role}">${avatar} ${name}</span>`;
  const isGrant = role === 'grant';
  document.getElementById('role-banner-wrap').innerHTML = isGrant
    ? `<div class="role-banner grant">ü¶Ö <span><strong>Grant's view</strong> ‚Äî Add tasks, respond to Will's requests.</span></div>`
    : `<div class="role-banner will">ü¶Å <span><strong>Will's view</strong> ‚Äî Start tasks, flag Grant when blocked.</span></div>`;
  document.getElementById('add-bar').style.display = isGrant ? 'flex' : 'none';
  document.getElementById('iz').style.display = isGrant ? 'flex' : 'none';
  document.getElementById('page-title').innerHTML = isGrant ? 'GRANT\'S <span>BOARD</span>' : 'WILL\'S <span>TASKS</span>';
  if (isGrant) document.getElementById('fab').style.removeProperty('display');
  startListening();
}
window.showModal = function() { document.getElementById('modal').style.display = 'flex'; }

/* ‚îÄ‚îÄ Firestore listener ‚îÄ‚îÄ */
let renderTimer = null;
function startListening() {
  setSync('busy');
  onSnapshot(
    query(collection(db,'tasks'), orderBy('ts','desc')),
    snap => {
      tasks = snap.docs.map(d=>({firestoreId:d.id,...d.data()}));
      setSync('ok');
      // Debounce rapid updates into a single render
      clearTimeout(renderTimer);
      renderTimer = setTimeout(() => {
        renderAll();
        if (activeTaskId) renderModal();
      }, 150);
    },
    err => { console.error(err); setSync('err'); }
  );
}

/* ‚îÄ‚îÄ Add task ‚îÄ‚îÄ */
window.addTask = function() {
  if(!me||me.role!=='grant') return;
  const inp=document.getElementById('task-input'), text=inp.value.trim();
  if(!text) return;
  pushTask(text, document.getElementById('cat-sel').value, document.getElementById('pri-sel').value,
    document.getElementById('due-input').value||null, document.getElementById('note-input').value.trim());
  inp.value=''; document.getElementById('due-input').value=''; document.getElementById('note-input').value='';
}
window.addTaskMobile = function() {
  if(!me||me.role!=='grant'){closeSheet();return;}
  const text=document.getElementById('sheet-task').value.trim(); if(!text) return;
  pushTask(text, document.getElementById('sheet-cat').value, document.getElementById('sheet-pri').value,
    document.getElementById('sheet-due').value||null, document.getElementById('sheet-note').value.trim());
  ['sheet-task','sheet-due','sheet-note'].forEach(id=>document.getElementById(id).value='');
  closeSheet();
}
async function pushTask(text,cat,priority,due,note) {
  try {
    setSync('busy');
    await addDoc(collection(db,'tasks'),{text,cat,priority,due,note:note||'',status:'pending',done:false,author:me.name,av:me.avatar,comments:[],ts:Date.now()});
    toast('‚úÖ','Task added!');
  } catch(e){toast('‚ùå','Failed to add');setSync('err');}
}

/* ‚îÄ‚îÄ Delete ‚îÄ‚îÄ */
window.deleteTask = async function(fid) {
  if(!me||me.role!=='grant') return;
  if(activeTaskId===fid) closeTaskModal();
  try{await deleteDoc(doc(db,'tasks',fid));toast('üóëÔ∏è','Removed');}
  catch(e){toast('‚ùå','Could not delete');}
}

/* ‚îÄ‚îÄ Task modal ‚îÄ‚îÄ */
window.openTask = function(fid) {
  activeTaskId = fid;
  document.getElementById('comment-input').value = '';
  renderModal();
  document.getElementById('task-modal').classList.add('open');
}
window.closeTaskModal = function() { document.getElementById('task-modal').classList.remove('open'); activeTaskId=null; }
window.taskModalBgClick = function(ev) { if(ev.target===document.getElementById('task-modal')) closeTaskModal(); }

function renderModal() {
  const t = tasks.find(x=>x.firestoreId===activeTaskId);
  if(!t){closeTaskModal();return;}
  const isGrant=me?.role==='grant', isWill=me?.role==='will';
  const status=t.status||'pending';

  document.getElementById('tmd-title').textContent = t.text;
  document.getElementById('tmd-meta').innerHTML = `
    ${dueChip(t.due)}
    <span class="tcat">${t.cat}</span>
    <span class="tpri ${t.priority==='high'?'ph':t.priority==='low'?'pl':'pm'}">${t.priority}</span>
    <span class="status-chip sc-${status}">${STATUS_LABEL[status]}</span>
    ${t.note?`<span style="font-size:11px;color:var(--muted);">üìù ${esc(t.note)}</span>`:''}
  `;

  const comments=t.comments||[];
  const thread=document.getElementById('tmd-comments');
  thread.innerHTML = comments.length
    ? comments.map(c=>`
        <div class="comment by-${c.author.toLowerCase()}">
          <div class="comment-header">
            <span class="comment-author">${c.av} ${esc(c.author)}</span>
            <span class="comment-time">${fmtTime(c.ts)}</span>
          </div>
          <div class="comment-text">${esc(c.text)}</div>
        </div>`).join('')
    : '<div class="no-comments">No messages yet.</div>';
  setTimeout(()=>thread.scrollTop=thread.scrollHeight, 30);

  // Handoff buttons ‚Äî always rendered, current state gets highlight ring
  const hd=document.getElementById('tmd-handoff');
  hd.innerHTML='';

  if(isWill){
    hd.innerHTML+=hbtn('hbtn-start',status==='in-progress','‚ñ∂ Start',`setStatus('${t.firestoreId}','in-progress')`);
    hd.innerHTML+=hbtn('hbtn-needs-grant',status==='needs-grant','üôã Needs Grant',`flagGrant('${t.firestoreId}')`);
    hd.innerHTML+=hbtn('hbtn-done',status==='done','‚úÖ Mark Done',`setStatus('${t.firestoreId}','done')`);
    hd.innerHTML+=hbtn('hbtn-reopen',false,'‚Ü©Ô∏è Reopen',`setStatus('${t.firestoreId}','pending')`);
  }
  if(isGrant){
    hd.innerHTML+=hbtn('hbtn-start',status==='in-progress','‚ñ∂ Start',`setStatus('${t.firestoreId}','in-progress')`);
    hd.innerHTML+=hbtn('hbtn-needs-will',status==='needs-will','üü£ Back to Will',`flagWill('${t.firestoreId}')`);
    hd.innerHTML+=hbtn('hbtn-done',status==='done','‚úÖ Mark Done',`setStatus('${t.firestoreId}','done')`);
    hd.innerHTML+=hbtn('hbtn-reopen',false,'‚Ü©Ô∏è Reopen',`setStatus('${t.firestoreId}','pending')`);
    hd.innerHTML+=hbtn('hbtn-delete',false,'üóëÔ∏è Delete',`deleteTask('${t.firestoreId}')`);
  }
}
function hbtn(cls,active,label,onclick){
  return `<button class="hbtn ${cls}${active?' current':''}" onclick="${onclick}">${label}</button>`;
}

/* ‚îÄ‚îÄ Status & handoff ‚îÄ‚îÄ */
window.setStatus = async function(fid,status) {
  try{
    await updateDoc(doc(db,'tasks',fid),{status,done:status==='done'});
    toast(status==='done'?'‚úÖ':'üîÑ',status==='done'?'Done!':'Updated');
  }catch(e){toast('‚ùå','Could not update');}
}
window.flagGrant = async function(fid) {
  const comment=document.getElementById('comment-input').value.trim();
  const upd={status:'needs-grant',done:false};
  if(comment) upd.comments=arrayUnion({author:me.name,av:me.avatar,text:comment,ts:Date.now()});
  try{
    await updateDoc(doc(db,'tasks',fid),upd);
    document.getElementById('comment-input').value='';
    toast('üôã','Grant flagged!');
  }catch(e){toast('‚ùå','Could not send');}
}
window.flagWill = async function(fid) {
  const comment=document.getElementById('comment-input').value.trim();
  const upd={status:'needs-will',done:false};
  if(comment) upd.comments=arrayUnion({author:me.name,av:me.avatar,text:comment,ts:Date.now()});
  try{
    await updateDoc(doc(db,'tasks',fid),upd);
    document.getElementById('comment-input').value='';
    toast('üü£','Sent back to Will!');
  }catch(e){toast('‚ùå','Could not send');}
}
window.submitComment = async function() {
  const text=document.getElementById('comment-input').value.trim();
  if(!text||!activeTaskId||!me) return;
  try{
    await updateDoc(doc(db,'tasks',activeTaskId),{comments:arrayUnion({author:me.name,av:me.avatar,text,ts:Date.now()})});
    document.getElementById('comment-input').value='';
  }catch(e){toast('‚ùå','Could not send');}
}

/* ‚îÄ‚îÄ Filters ‚îÄ‚îÄ */
window.setFilter = function(f,el){
  filter=f;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  renderTaskList();
}
function getFiltered(){
  if(filter==='active') return tasks.filter(t=>!t.done);
  if(filter==='in-progress') return tasks.filter(t=>t.status==='in-progress');
  if(filter==='needs-grant') return tasks.filter(t=>t.status==='needs-grant');
  if(filter==='done') return tasks.filter(t=>t.done);
  if(filter==='high') return tasks.filter(t=>t.priority==='high');
  return tasks;
}

/* ‚îÄ‚îÄ Render all ‚îÄ‚îÄ */
function renderAll(){
  const total=tasks.length,done=tasks.filter(t=>t.done).length,pending=total-done;
  const high=tasks.filter(t=>t.priority==='high'&&!t.done).length;
  const ng=tasks.filter(t=>t.status==='needs-grant').length;
  ['tc','pc','dc','hc'].forEach((id,i)=>document.getElementById(id).textContent=[total,pending,done,high][i]);
  ['mtc','mpc','mdc','mhc','mac'].forEach((id,i)=>document.getElementById(id).textContent=[total,pending,done,high,ng][i]);
  const pct=total?Math.round(done/total*100):0;
  const c=2*Math.PI*45;
  document.getElementById('ring').style.strokeDashoffset=c-(pct/100)*c;
  document.getElementById('pct').textContent=pct+'%';
  const cats={};tasks.forEach(t=>{cats[t.cat]=(cats[t.cat]||0)+1;});
  document.getElementById('catlist').innerHTML=Object.entries(cats).map(([c,n])=>
    `<div class="ci"><div class="cdot" style="background:${CAT_C[c]||'#888'}"></div><div class="cn">${c}</div><div class="cc">${n}</div></div>`
  ).join('')||'<div style="font-size:11px;color:var(--muted);padding:4px 8px">No tasks yet</div>';
  const up=tasks.filter(t=>!t.done&&t.due).map(t=>({...t,d:daysUntil(t.due)})).filter(t=>t.d>=0&&t.d<=7).sort((a,b)=>a.d-b.d).slice(0,5);
  document.getElementById('upcoming').innerHTML=up.length
    ?up.map(t=>`<div class="up-item" onclick="openTask('${t.firestoreId}')"><div class="up-text">${esc(t.text)}</div><div class="up-date">${dueChip(t.due)}</div></div>`).join('')
    :'<div style="font-size:11px;color:var(--muted);padding:3px 0">Nothing due soon</div>';
  document.getElementById('oulist').innerHTML=me
    ?`<div class="ou-row"><div class="ou-dot"></div>${me.avatar} ${esc(me.name)} (you)</div>`
    :'<div style="font-size:11px;color:var(--muted)">Not logged in</div>';
  renderAlerts();
  renderTaskList();
}

function renderAlerts(){
  if(!me) return;
  const isGrant=me.role==='grant', isWill=me.role==='will';
  const ngTasks=tasks.filter(t=>t.status==='needs-grant');
  const nwTasks=tasks.filter(t=>t.status==='needs-will');
  const gw=document.getElementById('grant-action-wrap');
  if(isGrant&&ngTasks.length){
    gw.style.display='block';
    gw.innerHTML=`<div class="alert-section grant-alert">
      <div class="alert-header"><span class="alert-badge orange">‚ö° ACTION REQUIRED</span><span style="font-size:12px;color:var(--muted)">${ngTasks.length} item${ngTasks.length>1?'s':''} need your attention</span></div>
      ${ngTasks.map(t=>{const last=(t.comments||[]).slice(-1)[0];return`<div class="alert-item" onclick="openTask('${t.firestoreId}')"><div class="alert-item-title">${esc(t.text)}</div>${last?`<div class="alert-last-msg"><strong>${esc(last.author)}:</strong> ${esc(last.text)}</div>`:''}</div>`;}).join('')}
    </div>`;
  } else gw.style.display='none';

  const ww=document.getElementById('will-waiting-wrap');
  if(isWill&&nwTasks.length){
    ww.style.display='block';
    ww.innerHTML=`<div class="alert-section will-alert">
      <div class="alert-header"><span class="alert-badge purple">‚è≥ WAITING ON GRANT</span></div>
      ${nwTasks.map(t=>{const last=(t.comments||[]).slice(-1)[0];return`<div class="alert-item purple-item" onclick="openTask('${t.firestoreId}')"><div class="alert-item-title">${esc(t.text)}</div>${last?`<div class="alert-last-msg purple"><strong>${esc(last.author)}:</strong> ${esc(last.text)}</div>`:''}</div>`;}).join('')}
    </div>`;
  } else ww.style.display='none';
}

/* ‚îÄ‚îÄ Task list ‚Äî diff render to prevent flash ‚îÄ‚îÄ */
function renderTaskList(){
  const filtered=getFiltered();
  const list=document.getElementById('tlist');
  const isGrant=me?.role==='grant';
  if(!filtered.length){list.innerHTML=`<div class="empty"><span class="empty-i">‚úì</span>Nothing here ‚Äî all clear!</div>`;return;}

  const newIds=filtered.map(t=>t.firestoreId);
  const existing=Array.from(list.querySelectorAll('.ti[data-fid]'));
  const existingIds=existing.map(el=>el.dataset.fid);

  // Full rebuild only if list order/length changed
  if(existingIds.join(',')!==newIds.join(',')){
    list.innerHTML=filtered.map((t,i)=>cardHTML(t,i,isGrant)).join('');
    attachCardListeners(list);
    return;
  }

  // Patch only changed cards ‚Äî no flash
  existing.forEach(el=>{
    const fid=el.dataset.fid;
    const t=tasks.find(x=>x.firestoreId===fid);
    if(!t) return;
    const newHTML=cardInnerHTML(t,isGrant);
    const newClass=cardClass(t);
    if(el.className!==newClass) el.className=newClass;
    if(el.getAttribute('data-inner')!==newHTML){
      el.innerHTML=newHTML;
      el.setAttribute('data-inner',newHTML);
      el.onclick=()=>openTask(fid);
      const db=el.querySelector('.dbtn');
      if(db) db.onclick=ev=>{ev.stopPropagation();deleteTask(fid);};
    }
  });
}

function cardClass(t){
  const status=t.status||'pending';
  const isOverdue=!t.done&&t.due&&daysUntil(t.due)<0;
  return`ti ${t.done?'is-done':''} ${isOverdue?'overdue-row':''} status-${status}`.trim().replace(/\s+/g,' ');
}
function cardInnerHTML(t,isGrant){
  const status=t.status||'pending';
  const cc=(t.comments||[]).length;
  return`<div class="status-dot sd-${status}"></div>
  <div class="ti-body">
    <div class="tt">${esc(t.text)}</div>
    <div class="tm">
      ${dueChip(t.due)}
      <span class="tauth">${t.av||''} ${esc(t.author||'')}</span>
      <span class="tcat">${t.cat}</span>
      <span class="tpri ${t.priority==='high'?'ph':t.priority==='low'?'pl':'pm'}">${t.priority}</span>
      <span class="status-chip sc-${status}">${STATUS_LABEL[status]}</span>
    </div>
  </div>
  <div class="ti-right">
    <span class="comment-pill${cc>0?' has-c':''}">üí¨ ${cc}</span>
    ${isGrant?`<button class="dbtn">‚úï</button>`:''}
  </div>`;
}
function cardHTML(t,i,isGrant){
  const fid=t.firestoreId;
  const inner=cardInnerHTML(t,isGrant);
  return`<div class="${cardClass(t)}" data-fid="${fid}" data-inner="${inner.replace(/"/g,'&quot;')}" style="--dc:${CAT_C[t.cat]||'#888'};animation-delay:${i*0.02}s">${inner}</div>`;
}
function attachCardListeners(list){
  list.querySelectorAll('.ti[data-fid]').forEach(el=>{
    const fid=el.dataset.fid;
    el.onclick=()=>openTask(fid);
    const db=el.querySelector('.dbtn');
    if(db) db.onclick=ev=>{ev.stopPropagation();deleteTask(fid);};
  });
}

/* ‚îÄ‚îÄ Import ‚îÄ‚îÄ */
const iz=document.getElementById('iz'),fi=document.getElementById('file-input');
iz.addEventListener('dragover',ev=>{ev.preventDefault();iz.classList.add('drag-over');});
iz.addEventListener('dragleave',()=>iz.classList.remove('drag-over'));
iz.addEventListener('drop',ev=>{ev.preventDefault();iz.classList.remove('drag-over');if(ev.dataTransfer.files[0])processFile(ev.dataTransfer.files[0]);});
fi.addEventListener('change',ev=>{if(ev.target.files[0])processFile(ev.target.files[0]);});
async function processFile(file){
  if(!me||me.role!=='grant'){toast('‚ö†Ô∏è','Only Grant can import');return;}
  const reader=new FileReader();
  reader.onload=async ev=>{
    try{
      const wb=XLSX.read(ev.target.result,{type:'array'});
      const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,defval:''});
      if(!rows.length){toast('‚ùå','Empty file');return;}
      let tc=0,cc=-1,pc=-1,dc=-1,nc=-1;
      rows[0].map(h=>String(h).toLowerCase()).forEach((h,i)=>{
        if(/task|title|name|item|desc|todo/.test(h))tc=i;
        if(/cat|category/.test(h))cc=i;
        if(/pri|priority/.test(h))pc=i;
        if(/due|deadline|date/.test(h))dc=i;
        if(/note|comment/.test(h))nc=i;
      });
      let added=0;
      for(let i=(rows[0][tc]?1:0);i<rows.length;i++){
        const row=rows[i],text=String(row[tc]||'').trim(); if(!text)continue;
        let cat='Other';if(cc>=0&&row[cc]){const r=String(row[cc]).trim();cat=Object.keys(CAT_C).find(c=>c.toLowerCase()===r.toLowerCase())||'Other';}
        let pri='med';if(pc>=0&&row[pc]){const r=String(row[pc]).toLowerCase();if(/high|urgent/.test(r))pri='high';else if(/low/.test(r))pri='low';}
        let due=null;if(dc>=0&&row[dc]){const r=row[dc];if(typeof r==='number'&&r>40000){const d=new Date(Math.round((r-25569)*86400*1000));due=d.toISOString().split('T')[0];}else{const d=new Date(r);if(!isNaN(d.getTime()))due=d.toISOString().split('T')[0];}}
        const note=(nc>=0&&row[nc])?String(row[nc]).trim():'';
        await addDoc(collection(db,'tasks'),{text,cat,priority:pri,due,note,status:'pending',done:false,author:me.name,av:me.avatar,comments:[],ts:Date.now()});
        added++;
      }
      toast('üìä',`Imported ${added} task${added!==1?'s':''}`);fi.value='';
    }catch(err){toast('‚ùå','Could not read file');}
  };
  reader.readAsArrayBuffer(file);
}

/* ‚îÄ‚îÄ Mobile sheet ‚îÄ‚îÄ */
window.openSheet=function(){document.getElementById('add-sheet').classList.add('open');setTimeout(()=>document.getElementById('sheet-task').focus(),300);}
window.closeSheet=function(){document.getElementById('add-sheet').classList.remove('open');}
window.sheetBgClick=function(ev){if(ev.target===document.getElementById('add-sheet'))closeSheet();}

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function todayStr(){return new Date().toISOString().split('T')[0];}
function daysUntil(due){if(!due)return null;return Math.round((new Date(due+'T00:00:00')-new Date(todayStr()+'T00:00:00'))/86400000);}
function dueChip(due){
  if(!due)return'';const d=daysUntil(due);
  const label=d<0?`${Math.abs(d)}d overdue`:d===0?'Today':d===1?'Tomorrow':`${d}d`;
  const cls=d<0?'overdue':d===0?'today':d<=3?'soon':'future';
  return`<span class="due-chip ${cls}">üìÖ ${label}</span>`;
}
function fmtTime(ts){
  if(!ts)return'';const d=new Date(ts);
  return d.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' '+d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
}
window.toast=function(icon,msg){
  const ex=document.querySelector('.toast');if(ex)ex.remove();
  const el=document.createElement('div');el.className='toast';
  el.innerHTML=`<span>${icon}</span> ${msg}`;document.body.appendChild(el);
  setTimeout(()=>el.remove(),3000);
}
window.setSync=function(s){
  const d=document.getElementById('sdot'),l=document.getElementById('slbl');
  d.className='sdot '+(s==='ok'?'ok':s==='busy'?'busy':'err');
  l.textContent=s==='ok'?'Live':s==='busy'?'Syncing‚Ä¶':'Error';
}

function tick(){
  const n=new Date();
  document.getElementById('ds').textContent=n.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  document.getElementById('ts').textContent=n.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
}

document.getElementById('task-input').addEventListener('keydown',ev=>{if(ev.key==='Enter')addTask();});
document.getElementById('sheet-task').addEventListener('keydown',ev=>{if(ev.key==='Enter')addTaskMobile();});
document.getElementById('comment-input').addEventListener('keydown',ev=>{if(ev.key==='Enter'&&!ev.shiftKey){ev.preventDefault();submitComment();}});

tick(); setInterval(tick,1000);
setTimeout(()=>{document.getElementById('loading').style.display='none';document.getElementById('modal').style.display='flex';},1000);
</script>
</body>
</html>
